<title>菜单管理</title>
<script>
    //加载css
    layui.link('/css/bootstrapStyle.css');
</script>
<div class="layui-fluid system-menu">
    <div class="layui-row layui-col-space15">
        <div class="layui-card">
            <div class="layui-card-body">
                <div class="layui-row">
                    <div class="layui-col-sm4 ztree">
                        <h3 class="layui-row layui-code-h3">菜单结构</h3>
                        <div class="layui-row" id="treeDemo"></div>
                        <div class="layui-row"><a class="addMenuRootNodeBtn" href="javascript:;" id="addMenuRootNodeBtn">添加根菜单</a></div>
                    </div>
                    <div class="layui-col-sm3">
                        <h3>菜单详情</h3>
                        <div class="layui-fluid">
                            <form class="layui-form" action="">
                                <div class="layui-form-item">
                                    <label class="layui-form-label">菜单名</label>
                                    <div class="layui-input-block"><input type="text" name="sm_label" required  lay-verify="required" placeholder="菜单名" autocomplete="off" class="layui-input" /></div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">父菜单</label>
                                    <div class="layui-input-block"><input type="text" name="sm_parent_name" disabled placeholder="父菜单" autocomplete="off" class="layui-input" /></div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">前端对应地址</label>
                                    <div class="layui-input-block"><input type="text" name="sm_view" placeholder="菜单对应地址" autocomplete="off" class="layui-input" /></div>
                                </div>
                                <div class="layui-form-item">
                                    <label class="layui-form-label">icon</label>
                                    <div class="layui-input-block"><input type="text" name="sm_icon" placeholder="icon" autocomplete="off" class="layui-input" /></div>
                                </div>
                                <div class="layui-form-item">
                                    <div class="layui-input-block">
                                        <input type="hidden" name="sm_parent_id">
                                        <input type="hidden" name="sm_id">
                                        <input type="hidden" name="sort_by">
                                        <button class="layui-btn" lay-submit="" lay-filter="save-menu">修改</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
layui.use(['form', 'ztutil', 'admin', 'view', 'element', 'jqueryZtreeCore', 'jqueryZtreeExedit'], function() {

    var $ = layui.jquery, form = layui.form, admin = layui.admin, view = layui.view, element = layui.element, jqueryZtreeCore = layui.jqueryZtreeCore;

    //监听保存
    form.on('submit(save-menu)', function (data) {
        var action = (data.field.sm_id && parseInt(data.field.sm_id) !== -1) ? 'update?id=' + data.field.sm_id : 'create';
        var tips = (action === 'create') ? '添加成功' : '修改成功';
        if (parseInt(data.field.sm_id) === -1) {
            delete data.field.sm_id;
        }
        var options = {
            data: data.field,
            url: '/admin/menu/' + action,
            method: (action === 'create' ? 'post' : 'patch'),
            done: function (res) {
                if (action === 'create') {//如果是添加，将返回的id同步到表单
                    $('input[name="sm_id"]').val(res.data.sm_id);
                }
                //同步表单数据到节点中
                synchronizationForm2TreeNode();
                layer.msg(tips);
            }
        };
        admin.req(options);
        return false;
    });

    var setting = {
        view: {
            addHoverDom: addHoverDom,
            removeHoverDom: removeHoverDom,
            selectedMulti: false
        },
        check: {
            enable: false
        },
        data: {
            key: {
                name: "sm_label"
            },
            simpleData: {
                enable: true,
                idKey: "sm_id",
                pIdKey: "sm_parent_id"
            }
        },
        edit: {
            enable: true,
            drag:{
                isCopy: false,
                isMove: true
            }
        },
        callback: {
            beforeEditName: zTreeBeforeEditName,
            beforeRemove: zTreeBeforeRemove,
            onClick: zTreeOnClick,
            onDrop: zTreeOnDrop
        }
    };


    var options = {
        url: '/admin/menu/index',
        method: 'get',
        done: function (res) {
            jqueryZtreeCore.init($("#treeDemo"), setting, res.data);
        }
    };
    admin.req(options);

    var newTmpId = -1;
    //鼠标监听
    function addHoverDom(treeId, treeNode) {
        //添加样式
        var sObj = $("#" + treeNode.tId + "_span");
        var btn = $("#addBtn_" + treeNode.tId);
        if (btn.length === 0) {
            //添加临时节点后，渲染新节点到表单中
            var addStr = "<span class='button add' id='addBtn_" + treeNode.tId
                + "' title='新建菜单' onfocus='this.blur();'></span>";
            sObj.after(addStr);
            btn = $("#addBtn_" + treeNode.tId);
            btn.bind("click", function() {
                if (!checkAllNodeHasSaved()) {
                    view.error('有新节点未保存，请保存或删除后再添加！');
                    return false;
                }
                var zTree = jqueryZtreeCore.getZTreeObj("treeDemo");
                zTree.addNodes(treeNode, {sm_id: newTmpId, sm_parent_id: treeNode.id, sm_label:"新建菜单"});
                var newNode = zTree.getNodesByParam('sm_id', newTmpId);
                zTree.selectNode(newNode[0]);
                synchronizationTreeNode2Form(newNode[0]);
                return false;
            });
        }
    }

    //绑定增加根节点的事件
    $('#addMenuRootNodeBtn').on('click', function () {
        var treeNode = null;
        if (!checkAllNodeHasSaved()) {
            view.error('有新节点未保存，请保存或删除后再添加！');
            return false;
        }
        var zTree = jqueryZtreeCore.getZTreeObj("treeDemo");
        zTree.addNodes(treeNode, {sm_id: newTmpId, sm_parent_id: 0, sm_label:"新建菜单"});
        var newNode = zTree.getNodesByParam('sm_id', newTmpId);
        zTree.selectNode(newNode[0]);
        synchronizationTreeNode2Form(newNode[0]);
        return false;
    });

    //删除监听
    function removeHoverDom(treeId, treeNode) {
        $("#addBtn_"+treeNode.tId).unbind().remove();
    }

    //监听编辑节点时，同步数据到表单
    function zTreeBeforeEditName(treeId, treeNode) {
        synchronizationTreeNode2Form(treeNode);
        return false;
    }

    //监听点击事件，同步数据到表单
    function zTreeOnClick(event, treeId, treeNode) {
        synchronizationTreeNode2Form(treeNode);
        return false;
    }

    //监听删除操作，先请求服务器删除，在删除页面数据
    function zTreeBeforeRemove(treeId, treeNode) {
        if (treeNode.isParent) {view.error('不能直接删除父菜单！');return false;}
        if (parseInt(treeNode.sm_id) === newTmpId) return true;

        var parentNode = treeNode.getParentNode();

        var options = {
            url: '/admin/menu/delete?id=' + treeNode.sm_id,
            method: 'delete',
            done: function (res) {
                if (res.code === 0) {
                    layer.msg('删除成功！');
                    return true;
                } else {
                    view.error(res.msg);
                    jqueryZtreeCore.getZTreeObj("treeDemo").addNodes(parentNode, treeNode);
                    return false;
                }
            },
            error: function (e, code) {
                var error = [
                    '请求异常，请重试<br><cite>错误信息：</cite>'+ code
                    ,debug()
                ].join('');
                view.error(error);

                jqueryZtreeCore.getZTreeObj("treeDemo").addNodes(parentNode, treeNode);
                return false;
            }
        };
        admin.req(options);
        return true;
    }

    //同步节点数据到表单
    function synchronizationTreeNode2Form(treeNode) {
        var parent_label = '无';
        var parentNode = treeNode.getParentNode();
        if (parentNode) {
            parent_label = parentNode.sm_label;
        }
        var prevNode = treeNode.getPreNode();
        var sort_by = prevNode ? prevNode.sm_id : 0;

        $('input[name="sm_label"]').val(treeNode.sm_label);
        $('input[name="sm_parent_name"]').val(parent_label);
        $('input[name="sm_view"]').val(treeNode.sm_view);
        $('input[name="sm_parent_id"]').val(parseInt(treeNode.sm_parent_id));
        $('input[name="sm_id"]').val(treeNode.sm_id);
        $('input[name="sort_by"]').val(sort_by);
        $('input[name="sm_icon"]').val(treeNode.sm_icon);
    }

    //同步表单数据到对应id的节点
    function synchronizationForm2TreeNode() {
        var sm_id_from_input = $('input[name="sm_id"]').val();
        //如果节点中没有sm_id的节点，则添加
        var synchronizingNode = jqueryZtreeCore.getZTreeObj("treeDemo").getNodeByParam('sm_id', sm_id_from_input);
        if (!synchronizingNode) {//如果未找到当前id的节点，则取临时节点
            synchronizingNode = jqueryZtreeCore.getZTreeObj("treeDemo").getNodeByParam('sm_id', newTmpId);
        }
        synchronizingNode.sm_id = sm_id_from_input;
        synchronizingNode.sm_label = $('input[name="sm_label"]').val();
        synchronizingNode.sm_view = $('input[name="sm_view"]').val();
        synchronizingNode.sort_by = $('input[name="sort_by"]').val();
        synchronizingNode.sm_icon = $('input[name="sm_icon"]').val();
        synchronizingNode.sm_parent_id = $('input[name="sm_parent_id"]').val();
        jqueryZtreeCore.getZTreeObj("treeDemo").updateNode(synchronizingNode);
    }

    //检查节点是否全部保存
    function checkAllNodeHasSaved() {
        return !jqueryZtreeCore.getZTreeObj("treeDemo").getNodeByParam('sm_id', newTmpId);
    }

    function zTreeOnDrop(event, treeId, treeNodes, targetNode, moveType) {
        //共需要修改三个节点。移动前的下一个节点、移动的节点、移动后的下一个节点
        var update_nodes = [];

        /**
         * 修改节点自身
         */
        var movedNodeParam = {};
        var movedNode = treeNodes[0];

        movedNodeParam.sm_parent_id = movedNode.sm_parent_id;
        if (!movedNodeParam.sm_parent_id) movedNodeParam.sm_parent_id = 0;

        //获取前一个节点的id为移动节点的前置id
        var prevNode = movedNode.getPreNode();
        var movedNodeNewSory = prevNode ? prevNode.sm_id : 0;
        if (movedNodeNewSory !== parseInt(movedNode.sort_by)) {
            movedNodeParam.sort_by = movedNodeNewSory;
        }
        if (Object.keys(movedNodeParam).length > 0) {
            movedNodeParam.sm_id = movedNode.sm_id;
            update_nodes.push(movedNodeParam);
        }

        /**
         * 修改移动后的下一个节点
         */
        var nextNode = movedNode.getNextNode();
        //获取后一个节点，重置后一个节点的前置id
        if (nextNode && parseInt(nextNode.sort_by) !== parseInt(movedNode.sm_id)) {
            update_nodes.push({
                sm_id: nextNode.sm_id,
                sort_by: movedNode.sm_id
            });
        }

        /**
         * 修改移动前的下一个节点
         */
        var moveBeforeNode = jqueryZtreeCore.getZTreeObj("treeDemo").getNodeByParam('sort_by', movedNode.sm_id);
        if (moveBeforeNode) {
            var moveBeforeNodePrevNode = moveBeforeNode.getPreNode();
            var moveBeforeNewSortBy = moveBeforeNodePrevNode ? moveBeforeNodePrevNode.sm_id : 0;
            if (moveBeforeNewSortBy !== parseInt(movedNode.sm_id)) {
                update_nodes.push({
                    sm_id: moveBeforeNode.sm_id,
                    sort_by: moveBeforeNewSortBy
                });
            }
        }

        if (prevNode && prevNode.sm_id !== parseInt(movedNode.sort_by)) {
            movedNode.sort_by = prevNode.sm_id;
        }
        if (nextNode && parseInt(nextNode.sort_by) !== parseInt(movedNode.sm_id)) {
            nextNode.sort_by = movedNode.sm_id;
        }
        if (moveBeforeNode && moveBeforeNewSortBy && moveBeforeNewSortBy !== parseInt(movedNode.sm_id)) {
            moveBeforeNode.sort_by = moveBeforeNewSortBy;
        }

        if (update_nodes.length > 0) {
            updateMenusSort(update_nodes);
        }
    }

    function updateMenusSort(nodes) {
        var options = {
            data: {nodes: nodes},
            url: '/admin/menu/update-sort',
            method: 'patch',
            done: function (res) {
                layer.msg(res.msg);
            }
        };
        admin.req(options);
    }

});

</script>