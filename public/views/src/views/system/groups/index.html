<title>角色列表</title>
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-card">
            <div class="layui-card-body">
                <div>
                    <form class="layui-form">
                        <div class="layui-inline">
                            <button class="layui-btn" id="btn-add-group">添加</button>
                        </div>
                        <div class="layui-inline">
                            <input class="layui-input" name="role_name" id="search_role_name" placeholder="角色名" autocomplete="off">
                        </div>
                        <button class="layui-btn" type="reset">重置</button>
                        <button class="layui-btn" id="searchReload">搜索</button>
                    </form>
                </div>
                <table class="layui-table" id="system-group" lay-size="lg" lay-filter="group"></table>
                <script type="text/html" id="group-option">
                    <a class="layui-btn layui-btn-sm layui-btn-primary" lay-event="permission">权限</a>
                    <a class="layui-btn layui-btn-sm" lay-event="edit">修改</a>
                    <a class="layui-btn layui-btn-sm layui-btn-danger" data-type="t" lay-event="del">删除</a>
                </script>
            </div>
        </div>
    </div>
</div>

<script>
layui.use(['table', 'laytpl', 'form', 'ztutil', 'admin', 'view', 'element'], function() {

    var $ = layui.jquery, table = layui.table, form = layui.form, laytpl = layui.laytpl, ztutil = layui.ztutil, admin = layui.admin, view = layui.view, element = layui.element;

    // 点击添加用户按钮
    $('#btn-add-group').on('click', function () {
        var data = {};
        var index = layer.load(1);
        layer.open({
            type: 1,
            id: 'LAY-system-groups-add',
            title: '添加角色',
            area: ['300px', '250px'],
            resize: false,
            success: function () {
                view(this.id).render('/system/groups/add', data).done(function () {
                    layer.close(index);
                    $(window).trigger('resize');
                });
            }
        });
        return false;
    });

    // 渲染角色列表
    table.render({
        elem: '#system-group',
        url:'/admin/system-group/index',
        where: ztutil.createSign(),
        size: 'lg',
        headers: {
            Authorization: ztutil.getToken()
        },
        cols: [[
            {type: 'checkbox'},
            {field:'sg_id', title:'角色编号', sort: true},
            {field:'sg_name', title:'角色名', sort: true},
            {field:'game_name', title:'管理游戏', sort: true},
            {field:'sg_desc', title:'描述', sort: true},
            {fixed: 'right', title:'操作', toolbar: '#group-option'}
        ]],
        page: true
    });

    //条件表单搜索
    $('#searchReload').on('click', function () {
        var role_name = $('#search_role_name').val();
        //执行重载
        table.reload('system-group', {
            page: {
                curr: 1 //重新从第 1 页开始
            }
            ,headers: {
                Authorization: ztutil.getToken()
            },where: {
                role_name: role_name
            }
        });
        return false;
    });

    // 获取权限列表以及管理产品、以及附加权限
    var getPrivileges = function (groupID, callback) {
        var gdata = '';
        var options = {
            url: '/admin/system-group/group-privilege-list?group_id=' + groupID,
            done: function (res) {
                gdata = res.data;
                var getTpl = $('#temp-edit-privileges').html();
                var view = $('#edit-privileges');
                view.empty();
                laytpl(getTpl).render(gdata, function (html) {
                    view.html(html);
                    // 记录当前行的数据 id
                    view.attr('group-id', groupID);
                    if (callback !== undefined) callback();
                });
            }
        };
        admin.req(options);
    };

    // 删除用户请求
    var deleteUser = function (id, obj) {
        var options = {
            url: '/admin/system-group/delete?id=' + id,
            method: 'delete',
            done: function () {
                obj.del();
                table.reload('system-group');
                layer.msg('删除用户成功！');
            }
        };
        admin.req(options);
    };

    // 监听工具条
    table.on('tool(group)', function(obj) {
        var data = obj.data;
        if (obj.event === 'permission') {
            layer.open({
                type: 1,
                id: 'LAY-system-groups-update-privileges',
                title: '修改权限',
                resize: true,
                area: ['650px', '500px'],
                success: function () {
                    view(this.id).render('system/groups/privileges', data).done(function () {
                        layer.close(index);
                        $(window).trigger('resize');
                    });
                }
            });
        } else if (obj.event === 'del') {
            layer.confirm('是否要删除角色：<strong>' + data.sg_name + '</strong> ？', {
            }, function(index) {
                deleteUser(data.sg_id, obj);
            });
        } else if (obj.event === 'edit') {
            var index = layer.load(1);
            layer.open({
                type: 1,
                id: 'LAY-system-groups-update',
                title: '修改角色',
                resize: false,
                success: function () {
                    view(this.id).render('/system/groups/update', data).done(function () {
                        layer.close(index);
                        $(window).trigger('resize');
                    });
                }
            });
        }
    });


});
</script>