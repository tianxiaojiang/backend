<title>角色列表</title>
<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb">
        <a lay-href="">主页</a>
        <a>
            <cite>系统管理</cite>
        </a>
        <a>
            <cite>角色列表</cite>
        </a>
    </div>
</div>
<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-card">
            <div class="layui-card-body">
                <div class="layui-btn-container">
                    <button class="layui-btn" id="btn-add-group">添加</button>
                </div>
                <table class="layui-table" id="system-group" lay-size="lg" lay-filter="group"></table>
                <script type="text/html" id="group-option">
                    <a class="layui-btn layui-btn-sm layui-btn-primary" lay-event="permission">权限</a>
                    <a class="layui-btn layui-btn-sm" lay-event="edit">修改</a>
                    <a class="layui-btn layui-btn-sm layui-btn-danger" data-type="t" lay-event="del">删除</a>
                </script>
            </div>
        </div>
    </div>
</div>
<script type="text/html" id="temp-edit-privileges">
    <div class="layui-fluid">
        <form class="layui-form form-privileges" action="" lay-filter="form-privileges">
            {{#  layui.each(d, function(index_data, data){ }}
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label"><strong id="privileges-smid">{{ data.sm_label }}</strong></label>
                <div class="layui-input-block">
                    <ul class="layui-privileges-list">
                        {{#  layui.each(data.privileges, function(index_labels, labels){ }}
                        <li>
                            <input type="checkbox" name="privileges_{{ labels.sp_id }}" value="{{ labels.sp_id }}" lay-skin="primary"  title="{{ labels.sp_label }}" {{ labels.is_checked ? 'checked' : '' }} />
                        </li>
                        {{#  }); }}
                    </ul>
                </div>
            </div>
            {{#  }); }}
            <div class="layui-form-item">
                <div class="layui-footer">
                    <button class="layui-btn" lay-submit lay-filter="btn-privileges">提交</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>   
</script>
<div id="edit-privileges" class="layui-hide"></div>
<script>
layui.use(['table', 'laytpl', 'form', 'ztutil', 'admin'], function() {
    var $ = layui.jquery, table = layui.table, form = layui.form, laytpl = layui.laytpl, ztutil = layui.ztutil, admin = layui.admin;
    table.render({
        elem: '#system-group',
        url:'/admin/system-group/index',
        where: ztutil.createSign(),
        size: 'lg',
        headers: {
            Authorization: ztutil.getToken()
        },
        cols: [[
            {type: 'checkbox'},
            {field:'sg_id', title:'角色编号', sort: true},
            {field:'sg_name', title:'角色名', sort: true},
            {field:'sg_desc', title:'描述', sort: true},
            {title:'操作', toolbar: '#group-option'}
        ]],
        page: true
    });

    // 获取权限列表请求
    function getPrivileges(groupID, callback) {
        var gdata = '';
        var options = {
            url: '/admin/system-group/group-privilege-list?group_id=' + groupID,
            done: function (res) {
                gdata = res.data; 
                var getTpl = $('#temp-edit-privileges').html();
                var view  = $('#edit-privileges');
                view.empty();
                laytpl(getTpl).render(gdata, function(html){               
                    view.html(html);
                    view.attr('group-id', groupID);
                    if (callback !== undefined) callback();
                });
            }
        };
        admin.req(options);
    }

    // 打开权限弹层
    var layerOpenPrivileges = function() {
        layer.open({
            type: 1,
            area: ['690px', 'auto'],
            title: '角色权限',
            content: $('#edit-privileges').html(),
            success: function (){                 
                form.render(null, 'form-privileges');
            }
        });
    };

    // 删除用户请求
    var deleteUser = function (id, obj) {
        var options = {
            url: '/admin/system-group/delete?id=' + id,
            method: 'delete',
            done: function () {
                obj.del();
                table.reload('system-group');
                layer.msg('删除用户成功！');
            }
        };
        admin.req(options);
    };

    // 监听用户权限提交
    form.on('submit(btn-privileges)', function(data){
        var groupID = $('#edit-privileges').attr("group-id");
        console.log(data);
        var options = {
            data: data.field,
            url: '/admin/system-group/group-privilege-update?group_id=' + groupID,
            method: 'patch',
            done: function (res) {
                layer.closeAll();
                table.reload('system-group');
                layer.msg('修改用户权限成功！');
            }
        };
        admin.req(options);
        return false;
    });

    // 监听工具条
    table.on('tool(group)', function(obj) {
        var data = obj.data;
        if (obj.event === 'permission') {
            getPrivileges(data.sg_id, layerOpenPrivileges);
        } else if (obj.event === 'del') {
            layer.confirm('是否要删除：<strong>' + data.sg_name + '</strong> 的角色？', {
            }, function(index) {
                deleteUser(data.sg_id, obj);
            });
        } else if (obj.event === 'edit') {
            layer.open({
                type: 1,
                area: ['400px'],
                title: '修改角色',
                content: '<div class="layui-fluid" id="edit-group">' +
                '<form class="layui-form" action="">' +
                '<div class="layui-form-item layui-hide">' +
                    '<label class="layui-form-label">角色编号</label>' +
                    '<div class="layui-input-block">' +
                      '<input type="text" name="id" required  lay-verify="required" placeholder="角色编号" value="' + data.sg_id + '" autocomplete="off" class="layui-input">' +
                    '</div>' +
                  '</div>' +
                  '<div class="layui-form-item">' +
                    '<label class="layui-form-label">角色名</label>' +
                    '<div class="layui-input-block">' +
                      '<input type="text" name="sg_name" required  lay-verify="required" placeholder="角色名" value="' + data.sg_name + '" autocomplete="off" class="layui-input">' +
                    '</div>' +
                  '</div>' +
                  '<div class="layui-form-item">' +
                    '<label class="layui-form-label">描述</label>' +
                    '<div class="layui-input-block">' +
                      '<input type="text" name="sg_desc" required  lay-verify="required" placeholder="描述" value="' + data.sg_desc + '" autocomplete="off" class="layui-input">' +
                    '</div>' +
                  '</div>' +
                  '<div class="layui-form-item">' +
                      '<div class="layui-input-block">' +
                          '<button class="layui-btn" lay-submit="" lay-filter="edit-group">提交</button>' +
                          '<button type="reset" class="layui-btn layui-btn-primary">重置</button>' +
                      '</div>' +
                  '</div>' +
                '</form>' +
            '</div>'
            });
        }
    });

    // 监听用户修改提交
    form.on('submit(edit-group)', function(data){
        var options = {
            data: data.field,
            url: '/admin/system-group/update?id=' + data.field.id,
            method: 'patch',
            done: function () {
                layer.closeAll();
                table.reload('system-group');
                layer.msg('修改用户成功！');
            }
        };
        admin.req(options);
        return false;
    });

    // 点击添加用户按钮
    $('#btn-add-group').on('click', function() {
        layer.open({
            type: 1,
            area: ['400px'],
            title: '添加用户',
            content: '<div class="layui-fluid" id="add-group">' +
                '<form class="layui-form" action="">' +
                  '<div class="layui-form-item">' +
                    '<label class="layui-form-label">角色名</label>' +
                    '<div class="layui-input-block">' +
                      '<input type="text" name="sg_name" required  lay-verify="required" placeholder="角色名" autocomplete="off" class="layui-input">' +
                    '</div>' +
                  '</div>' +
                  '<div class="layui-form-item">' +
                    '<label class="layui-form-label">描述</label>' +
                    '<div class="layui-input-block">' +
                      '<input type="text" name="sg_desc" required  lay-verify="required" placeholder="描述" autocomplete="off" class="layui-input">' +
                    '</div>' +
                  '</div>' +
                  '<div class="layui-form-item">' +
                      '<div class="layui-input-block">' +
                          '<button class="layui-btn" lay-submit="" lay-filter="add-group">提交</button>' +
                          '<button type="reset" class="layui-btn layui-btn-primary">重置</button>' +
                      '</div>' +
                  '</div>' +
                '</form>' +
            '</div>'
        });
    });

    // 提交添加用户按钮
    form.on('submit(add-group)', function(data){
        var options = {
            data: data.field,
            url: '/admin/system-group/create',
            method: 'post',
            done: function () {
                layer.closeAll();
                table.reload('system-group');
                layer.msg('添加用户成功！');
            }
        };
        admin.req(options);
        return false;
    });
});
</script>