<script type="text/html" template lay-url="/admin/common/game-lists" lay-done="getGameListCallback(d);">
    <div class="layui-fluid">
        <form class="layui-form" action="">
            <div class="layui-form-item">
                <label class="layui-form-label">游戏列表</label>
                <div class="layui-input-block" id="all_game_lists">
                </div>
            </div>
            <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit="" lay-filter="add-system-game">提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
        </form>
    </div>
</script>
<script>
var getGameListCallback = function(d) {
    var allGames = d.data.list;
    layui.use(['table', 'laytpl', 'form', 'ztutil', 'admin', 'view'], function () {

        var $ = layui.jquery, table = layui.table, form = layui.form, laytpl = layui.laytpl, ztutil = layui.ztutil, admin = layui.admin, view = layui.view;

        //先拉取自有的所有游戏
        var getSystemGames = function() {
            var options = {
                url: '/admin/system-game/index',
                method: 'get',
                data: {
                    limit: 10000
                },
                done: function (res) {
                    var sysytemGames = res.data;
                    var systemGameIds = [];
                    $.each(sysytemGames, function (k, v) {
                        systemGameIds.push(v.game_id);
                    });

                    var gameHtml = '';
                    $.each(allGames, function (k, v) {
                        var isChecked = (systemGameIds.indexOf(v.game_id) === -1) ? '' : ' checked';
                        gameHtml += '<input type="checkbox" name="system_game_id['+v.game_id+']" title="'+v.name + '('+ v.game_id +')"' +isChecked+ '>';
                    });

                    $('#all_game_lists').html(gameHtml);
                    form.render();
                }
            };
            admin.req(options);
        }

        getSystemGames();

        // 提交添加角色按钮
        form.on('submit(add-system-game)', function (data) {
            var options = {
                data: data.field,
                url: '/admin/system-game/create',
                method: 'post',
                done: function () {
                    layer.closeAll();
                    table.reload('table-system-game');
                    layer.msg('添加游戏成功！');
                }
            };
            admin.req(options);
            return false;
        });

    });
}
</script>