<script>
    //加载css
    layui.link('/css/easy-autocomplete.css');
</script>
<script type="text/html" template>
    <form class="layui-form" action="">
        <div class="layui-form-item">
            <label class="layui-form-label">账号类型：</label>
            <div class="layui-input-block">
                <select name="auth_type" id="add-admin-auth_type" lay-filter="auth_type_filter" required lay-verify="required">
                </select>
            </div>
        </div>
        <div class="layui-form-item auth_type_password" style="display: none;">
            <label class="layui-form-label">账号</label>
            <div class="layui-input-block"> <input type="text" name="account" placeholder="开发者账号" autocomplete="off" class="layui-input" /></div>
        </div>
        <div class="layui-form-item auth_type_password" style="display: none;">
            <label class="layui-form-label">初始密码</label>
            <div class="layui-input-block"> <input type="password" name="password" placeholder="开发者初始密码" autocomplete="off" class="layui-input" /></div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-block"><input type="text" name="username" placeholder="姓名" autocomplete="off" class="layui-input" /></div>
        </div>
        <div class="layui-form-item auth_type_no_password">
            <label class="layui-form-label">工号</label>
            <div class="layui-input-block"> <input type="number" name="staff_number" placeholder="开发者工号" autocomplete="off" class="layui-input" /></div>
        </div>
        <!--<div class="layui-form-item">-->
            <!--<label class="layui-form-label">账号</label>-->
            <!--<div class="layui-input-block"><input type="text" name="account" required lay-verify="required" placeholder="账号" autocomplete="off" class="layui-input" id="admin-add-account"/></div>-->
        <!--</div>-->
        <!--<div id="extendFieldBox">-->
            <!--<div class="layui-form-item">-->
                <!--<label class="layui-form-label">密码</label>-->
                <!--<div class="layui-input-block"> <input type="password" name="passwd" required lay-verify="required" placeholder="密码" autocomplete="off" class="layui-input" /></div>-->
            <!--</div>-->
            <!--<div class="layui-form-item">-->
                <!--<label class="layui-form-label">绑定手机</label>-->
                <!--<div class="layui-input-block"><input type="text" name="mobile_phone" placeholder="绑定手机" lay-verify="phone" autocomplete="off" class="layui-input" /></div>-->
            <!--</div>-->
            <!--<div class="layui-form-item">-->
                <!--<label class="layui-form-label">姓名</label>-->
                <!--<div class="layui-input-block"><input type="text" name="username" placeholder="姓名" autocomplete="off" class="layui-input" /></div>-->
            <!--</div>-->
            <!--<div class="layui-form-item">-->
                <!--<label class="layui-form-label">状态</label>-->
                <!--<div class="layui-input-block">-->
                    <!--<select name="status" required lay-verify="required">-->
                        <!--<option value="0">正常</option>-->
                        <!--<option value="1">禁止</option>-->
                    <!--</select>-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->
        <div class="layui-form-item">
            <label class="layui-form-label">角色名</label>
            <div class="layui-input-block">
                <select name="sg_id" id="add-admin-select-roles" lay-filter="select-roles" required lay-verify="required" multiple></select>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit="" lay-filter="add-admin">提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</script>
<script>
    layui.use(['table', 'laytpl', 'form', 'ztutil', 'admin', 'view', 'easyAutocomplete'], function () {

        var $ = layui.jquery, table = layui.table, form = layui.form, laytpl = layui.laytpl, ztutil = layui.ztutil, admin = layui.admin, view = layui.view, easyAutocomplete = layui.easyAutocomplete;

        //拉取所有管理员列表
        // var adminList = [];
        // var fetchAdminList = function () {
        //     optionStatus = {
        //         url: '/admin/common/admins',
        //         done: function (res) {
        //             adminList = res.data.admins;
        //             console.log(res);
        //             var options = {
        //                 data: res.data.admins,
        //                 getValue: 'account',
        //                 list: {
        //                     match: {
        //                         enabled: true
        //                     },
        //                     onChooseEvent: function() {
        //                         extendFiledTakeOutVerify();
        //                     }
        //                 }
        //             };
        //             $('#admin-add-account').easyAutocomplete(options);
        //         }
        //     };
        //     admin.req(optionStatus);
        // }
        // fetchAdminList();

        // 渲染开发者账号分类列表
        var renderAuthType = function () {
            var typesHTML = '',
                optionStatus = {
                    url: '/admin/common/admin-auth-types',
                    done: function (res) {
                        $.each(res.data.types, function (i, v) {
                            typesHTML += '<option value="' + i + '">' + v + '</option>';
                        });
                        $('#add-admin-auth_type').html(typesHTML);
                        form.render();
                    }
                };
            admin.req(optionStatus);
        };
        renderAuthType();

        form.on('select(auth_type_filter)', function(data) {
            var auth_type = parseInt(data.value);
            if (auth_type === 1) {//普通账密
                $(".auth_type_no_password").hide();
                $(".auth_type_password").show();
            } else {
                $(".auth_type_no_password").show();
                $(".auth_type_password").hide();
            }
        });

        // $('#admin-add-account').on('keyup', function () {
        //     extendFiledSubjoinVerify();
        // });

        // var extendFiledTakeOutVerify = function () {
        //     $('#extendFieldBox').hide();
        //     $('[name=passwd]').removeAttr('required').removeAttr('lay-verify');
        //     $('[name=mobile_phone]').removeAttr('required').removeAttr('lay-verify');
        //     $('[name=username]').removeAttr('required').removeAttr('lay-verify');
        //     $('[name=status]').removeAttr('required').removeAttr('lay-verify');
        // }
        // var extendFiledSubjoinVerify = function () {
        //     $('#extendFieldBox').show();
        //     $('[name=passwd]').attr('required', 'required').attr('lay-verify', 'required');
        //     $('[name=mobile_phone]').attr('required', 'required').attr('phone');
        //     $('[name=username]').attr('required', 'required').attr('lay-verify', 'required');
        //     $('[name=status]').attr('required', 'required').attr('lay-verify', 'required');
        // }

        // 渲染管理员状态列表
        // var renderStatus = function () {
        //     var statusHTML = '',
        //     optionStatus = {
        //         url: '/admin/common/admin-stats',
        //         done: function (res) {
        //             $.each(res.data, function (i, v) {
        //                 statusHTML += '<option value="' + i + '">' + v + '</option>';
        //             });
        //             $('#select-status').html(statusHTML);
        //             form.render();
        //         }
        //     };
        //     admin.req(optionStatus);
        // };

        // 获取角色名列表
        var renderRoleList = function () {
            var options = {
                url: '/admin/system-group/index?limit=10000',
                page: false,
                limit: 1000,
                done: function (res) {
                    var rolesListHTML = '<option value="">请选择角色名</option>';
                    $.each(res.data, function (i, v) {
                        // 当前角色名是否在列表中，即是否为选中状态
                        var isDisabled = parseInt(v.disabled) === 1 ? ' disabled="disabled"' : '';
                        rolesListHTML += '\n<option value="' + v.sg_id + '"' + isDisabled +'>' + v.sg_name + '</option>';
                    });
                    console.log(res.data);

                    $('#add-admin-select-roles').html(rolesListHTML);
                    form.render();
                }
            };
            admin.req(options);
        };

        // renderStatus();
        renderRoleList();

        // 提交添加管理员按钮
        var OperationInProgress = 0;
        form.on('submit(add-admin)', function (data) {
            if (OperationInProgress) {
                layer.msg("不要频繁操作，请稍等后重试！");
                return false;
            } else {
                OperationInProgress = 1;
            }
            data.field.sg_id = data.field.sg_id.join(',');
            var options = {
                data: data.field,
                url: '/admin/admin-user/create',
                method: 'post',
                done: function () {
                    OperationInProgress = 0;
                    layer.closeAll();
                    table.reload('system-admins-id');
                    layer.msg('添加用户成功！');
                }
            };
            admin.req(options);
            return false;
        });

        form.render();
    });
</script>